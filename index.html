<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Brille — Test Sender</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;background:#111;color:#eee;padding:16px}
  button{display:block;width:100%;padding:10px;margin:8px 0;border-radius:8px;border:none;font-size:15px;cursor:pointer}
  .log{background:#000;padding:10px;height:360px;overflow:auto;font-family:monospace;font-size:12px;white-space:pre-wrap}
</style>
</head>
<body>
  <h2>Brille — Test Sender</h2>
  <p>Shining-App schließen, Brille neu starten.</p>
  <button onclick="connectGlasses()">Connect Brille (Diagnose)</button>
  <div>
    <button onclick="sendAllTests()">Send: mehrere Test-Payloads an alle found-chars</button>
    <button onclick="sendOneByOne()">Send: sequenziell an bekannte proprietary chars</button>
    <button onclick="clearLog()">Clear Log</button>
  </div>
  <div class="log" id="log">Log startet...</div>

<script>
const GLASS_SERVICE_FFF0 = '0000fff0-0000-1000-8000-00805f9b34fb';
const PROPS = [
  'd44bc439-abfd-45a2-b575-925416129600',
  'd44bc439-abfd-45a2-b575-925416129601',
  'd44bc439-abfd-45a2-b575-92541612960a',
  'd44bc439-abfd-45a2-b575-92541612960b'
];

let server = null;
let foundChars = []; // {serviceUuid, char}

function log(s){
  const el = document.getElementById('log');
  el.textContent = `[${new Date().toLocaleTimeString()}] ${s}\n` + el.textContent;
  console.log(s);
}

async function connectGlasses(){
  try {
    log('requestDevice (acceptAllDevices, optional FFF0)...');
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [GLASS_SERVICE_FFF0]
    });
    log('Ausgewählt: ' + (device.name || device.id));
    device.addEventListener('gattserverdisconnected', () => { log('Brille: disconnected'); foundChars = []; server = null; });
    server = await device.gatt.connect();
    log('GATT connected. Enumerating services...');
    const services = await server.getPrimaryServices();
    for (const s of services){
      log('Service: ' + s.uuid);
      try {
        const chars = await s.getCharacteristics();
        for (const c of chars){
          log(' - Char: ' + c.uuid + ' props: ' + JSON.stringify(c.properties));
          // Collect write-capable and proprietary chars
          if (c.properties.write || c.properties.writeWithoutResponse || PROPS.includes(c.uuid)){
            foundChars.push({service: s.uuid, char: c});
          }
        }
      } catch(e){
        log('  -> Fehler beim Lesen der Characteristics: ' + (e && e.message));
      }
    }
    if (foundChars.length) log('Found ' + foundChars.length + ' candidate characteristics.');
    else log('Keine candidate characteristics gefunden.');
  } catch(e){
    log('Connect Fehler: ' + (e && (e.name + ' / ' + e.message)));
  }
}

/* Try multiple payload formats on every found char */
async function sendAllTests(){
  if (!foundChars.length){ log('Keine chars gefunden - bitte zuerst Connect'); return; }
  // common payloads to try
  const tests = [
    new Uint8Array([0x01]),
    new Uint8Array([0x02]),
    new TextEncoder().encode('A'),
    new TextEncoder().encode('B'),
    new Uint8Array([0xAA, 0x55, 0x01]),
    new Uint8Array([0x7E, 0x04, 0x01, 0x00]),
    new Uint8Array([0x00, 0x01, 0x02, 0x03])
  ];
  for (const t of tests){
    for (const entry of foundChars){
      try {
        await entry.char.writeValue(t);
        log('Wrote ' + hexDump(t) + ' -> ' + entry.char.uuid);
        await sleep(120); // short pause between writes
      } catch(e){
        log('Write Fehler ' + entry.char.uuid + ' : ' + (e && e.message));
      }
    }
    await sleep(250);
  }
  log('Alle Tests gesendet.');
}

/* send same single-byte to known proprietary chars in sequence */
async function sendOneByOne(){
  if (!server) { log('Nicht verbunden'); return; }
  try {
    const svc = await server.getPrimaryService(GLASS_SERVICE_FFF0);
    for (const uuid of PROPS){
      try {
        const c = await svc.getCharacteristic(uuid);
        await c.writeValue(new Uint8Array([0x01]));
        log('Sent 0x01 -> ' + uuid);
        await sleep(150);
      } catch(e){
        log('Nicht erreichbar: ' + uuid + ' (' + (e && e.message) + ')');
      }
    }
  } catch(e){
    log('FFF0 Service nicht zugreifbar: ' + (e && e.message));
  }
}

function hexDump(u8){
  return Array.from(u8).map(x => x.toString(16).padStart(2,'0')).join(' ');
}
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
function clearLog(){ document.getElementById('log').textContent = ''; foundChars = []; }

</script>
</body>
</html>
